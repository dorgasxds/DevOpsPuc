name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  # Job de CI (Continuous Integration)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Run unit tests
      run: |
        python -m unittest calculadora.py

    - name: Notificar Discord - Testes
      uses: Ilshidur/action-discord@master
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
        message: |
          üß™ **Testes Executados** 
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Status: ${{ job.status }}
          Commit: ${{ github.sha }}
          Executado por: ${{ github.actor }}

  # Job de CD (Continuous Deployment)
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    # Este job s√≥ ser√° executado ap√≥s o job de teste e apenas no branch main
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Test application functionality
      run: |
        python -c "
        from calculadora import calcular_tmb_homem, calcular_tmb_mulher
        print('Testando TMB para homem (70kg, 175cm, 30 anos):', calcular_tmb_homem(70, 175, 30))
        print('Testando TMB para mulher (60kg, 165cm, 25 anos):', calcular_tmb_mulher(60, 165, 25))
        print('Teste de implanta√ß√£o conclu√≠do com sucesso!')
        "
        
    - name: Simulate deployment
      run: |
        echo "Simulando processo de deployment..."
        echo "‚úÖ Aplica√ß√£o pronta para produ√ß√£o!"

    - name: Notificar Discord - Deploy
      uses: Ilshidur/action-discord@master
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
        message: |
          üöÄ **Deploy Realizado** 
          Reposit√≥rio: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Status: Deploy conclu√≠do com sucesso!
          Commit: ${{ github.sha }}

  # Job adicional para notifica√ß√µes gerais
  discord-notifications:
    name: Discord Notifications
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: always()
    
    steps:
    - name: Notificar status final do workflow
      uses: Ilshidur/action-discord@master
      with:
        webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
        message: |
          üìä **Workflow Conclu√≠do** 
          Reposit√≥rio: ${{ github.repository }}
          Workflow: ${{ github.workflow }}
          Status Geral: ${{ job.status }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Executado por: ${{ github.actor }}
